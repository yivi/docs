{"pageContext":{"html":"<h1 id=\"mongodb-support\"><a href=\"#mongodb-support\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MongoDB Support</h1>\n<h2 id=\"overview\"><a href=\"#overview\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h2>\n<p><a href=\"https://www.mongodb.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MongoDB</a> is one of the most popular NoSQL document-oriented database, used for its high\nwrite load (useful for analytics or IoT) and high availability (easy to set replica sets with automatic failover). It\ncan also shard the database easily for horizontal scalability and has a powerful query language for doing aggregation,\ntext search or geospatial queries.</p>\n<p>API Platform uses <a href=\"https://www.doctrine-project.org/projects/mongodb-odm.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Doctrine MongoDB ODM 2</a> and in particular\nits <a href=\"https://www.doctrine-project.org/projects/doctrine-mongodb-odm/en/latest/reference/aggregation-builder.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">aggregation builder</a>\nto leverage all the possibilities of the database.</p>\n<p>Doctrine MongoDB ODM 2 relies on the <a href=\"https://secure.php.net/manual/en/set.mongodb.php\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">mongodb</a> PHP extension and not on\nthe legacy <a href=\"https://secure.php.net/manual/en/book.mongo.php\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">mongo</a> extension.</p>\n<h2 id=\"enabling-mongodb-support\"><a href=\"#enabling-mongodb-support\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Enabling MongoDB Support</h2>\n<p>If the mongodb PHP extension is not installed yet, <a href=\"https://secure.php.net/manual/en/mongodb.installation.pecl.php\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">install it beforehand</a>.</p>\n<p>If you are using the <a href=\"/docs/distribution/\">API Platform Distribution</a>, modify the Dockerfile to add the extension:</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\"> // api/Dockerfile\n\n ...\n \tpecl install \\\n \t\tapcu-${APCU_VERSION} \\\n<span class=\"token inserted\">+\t\tmongodb \\</span>\n \t; \\\n ...\n \tdocker-php-ext-enable \\\n \t\tapcu \\\n \t\topcache \\\n<span class=\"token inserted\">+\t\tmongodb \\</span>\n \t; \\\n ...</code></pre></div>\n<p>Then rebuild the <code class=\"language-text\">php</code> image:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker-compose build php</code></pre></div>\n<p>Add a MongoDB image to the docker-compose file:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># docker-compose.yml</span>\n\n<span class=\"token comment\"># ...</span>\n  <span class=\"token key atrule\">db-mongodb</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># In production, you may want to use a managed database service</span>\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mongo\n      <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> MONGO_INITDB_DATABASE=api\n          <span class=\"token punctuation\">-</span> MONGO_INITDB_ROOT_USERNAME=api<span class=\"token punctuation\">-</span>platform\n          <span class=\"token comment\"># You should definitely change the password in production</span>\n          <span class=\"token punctuation\">-</span> MONGO_INITDB_ROOT_PASSWORD=<span class=\"token tag\">!ChangeMe!</span>\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> db<span class=\"token punctuation\">-</span>data<span class=\"token punctuation\">:</span>/var/lib/mongodb/data<span class=\"token punctuation\">:</span>rw\n          <span class=\"token comment\"># You may use a bind-mounted host directory instead, so that it is harder to accidentally remove the volume and lose all your data!</span>\n          <span class=\"token comment\"># - ./docker/db/data:/var/lib/mongodb/data:rw</span>\n      <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token string\">\"27017:27017\"</span>\n<span class=\"token comment\"># ...</span></code></pre></div>\n<p>Once the extension is installed, to enable the MongoDB support, require the <a href=\"https://github.com/doctrine/DoctrineMongoDBBundle\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Doctrine MongoDB ODM bundle</a>\npackage using Composer:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker-compose <span class=\"token function\">exec</span> php composer req doctrine/mongodb-odm-bundle:^4.0.0@beta doctrine/mongodb-odm:^2.0.0@beta</code></pre></div>\n<p>Execute the contrib recipe to have it already configured.</p>\n<p>Change the MongoDB environment variables to match your Docker image:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># api/.env\n\nMONGODB_URL=mongodb://api-platform:!ChangeMe!@db-mongodb\nMONGODB_DB=api</code></pre></div>\n<p>Change the configuration of API Platform to add the right mapping path:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># api/config/packages/api_platform.yaml</span>\n\n<span class=\"token key atrule\">api_platform</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># ...</span>\n\n    <span class=\"token key atrule\">mapping</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'%kernel.project_dir%/src/Entity'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'%kernel.project_dir%/src/Document'</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token comment\"># ...</span></code></pre></div>\n<h2 id=\"creating-documents\"><a href=\"#creating-documents\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating Documents</h2>\n<p>Creating resources mapped to MongoDB documents is as simple as creating entities:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// api/src/Document/Product.php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Document</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Annotation<span class=\"token punctuation\">\\</span>ApiResource</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Doctrine<span class=\"token punctuation\">\\</span>Common<span class=\"token punctuation\">\\</span>Collections<span class=\"token punctuation\">\\</span>ArrayCollection</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Doctrine<span class=\"token punctuation\">\\</span>ODM<span class=\"token punctuation\">\\</span>MongoDB<span class=\"token punctuation\">\\</span>Mapping<span class=\"token punctuation\">\\</span>Annotations</span> <span class=\"token keyword\">as</span> <span class=\"token constant\">ODM</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Symfony<span class=\"token punctuation\">\\</span>Component<span class=\"token punctuation\">\\</span>Validator<span class=\"token punctuation\">\\</span>Constraints</span> <span class=\"token keyword\">as</span> Assert<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @ApiResource\n *\n * @ODM\\Document\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Product</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * @ODM\\Id(strategy=\"INCREMENT\", type=\"integer\")\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token variable\">$id</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * @ODM\\Field\n     * @Assert\\NotBlank\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$name</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * @ODM\\ReferenceMany(targetDocument=Offer::class, mappedBy=\"product\", cascade={\"persist\"}, storeAs=\"id\")\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$offers</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">offers</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayCollection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">?</span>int\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">id</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">addOffer</span><span class=\"token punctuation\">(</span>Offer <span class=\"token variable\">$offer</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> void\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$offer</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">product</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">offers</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$offer</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">removeOffer</span><span class=\"token punctuation\">(</span>Offer <span class=\"token variable\">$offer</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> void\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$offer</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">product</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">offers</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">removeElement</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$offer</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// api/src/Document/Offer.php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Document</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">ApiPlatform<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Annotation<span class=\"token punctuation\">\\</span>ApiResource</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Doctrine<span class=\"token punctuation\">\\</span>ODM<span class=\"token punctuation\">\\</span>MongoDB<span class=\"token punctuation\">\\</span>Mapping<span class=\"token punctuation\">\\</span>Annotations</span> <span class=\"token keyword\">as</span> <span class=\"token constant\">ODM</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Symfony<span class=\"token punctuation\">\\</span>Component<span class=\"token punctuation\">\\</span>Validator<span class=\"token punctuation\">\\</span>Constraints</span> <span class=\"token keyword\">as</span> Assert<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * @ApiResource(iri=\"http://schema.org/Offer\")\n *\n * @ODM\\Document\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Offer</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * @ODM\\Id(strategy=\"INCREMENT\", type=\"integer\")\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token variable\">$id</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * @ODM\\Field\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$description</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * @ODM\\Field(type=\"float\")\n     * @Assert\\NotBlank\n     * @Assert\\Range(min=0, minMessage=\"The price must be superior to 0.\")\n     * @Assert\\Type(type=\"float\")\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$price</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * @ODM\\ReferenceOne(targetDocument=Product::class, inversedBy=\"offers\", storeAs=\"id\")\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$product</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Some important information about the mapping:</p>\n<ul>\n<li>Identifier fields always need to be integers with an increment strategy. API Platform does not support the native\n<a href=\"https://docs.mongodb.com/manual/reference/bson-types/#objectid\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ObjectId</a>.</li>\n<li>When defining references, always use the id for storing them instead of the native <a href=\"https://docs.mongodb.com/manual/reference/database-references/#dbrefs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">DBRef</a>.\nIt allows API Platform to manage <a href=\"/docs/core/filters/#apifilter-annotation\">filtering on nested properties</a> by using <a href=\"https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">lookups</a>.</li>\n</ul>\n<h2 id=\"filtering\"><a href=\"#filtering\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Filtering</h2>\n<p>Doctrine MongoDB ODM filters are practically the same as Doctrine ORM filters.</p>\n<p>See how to use them and how to create custom ones in the <a href=\"/docs/core/filters/\">filters documentation</a>.</p>\n<h2 id=\"creating-custom-extensions\"><a href=\"#creating-custom-extensions\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating Custom Extensions</h2>\n<p>See how to create Doctrine MongoDB ODM custom extensions in the <a href=\"/docs/core/extensions/\">extensions documentation</a>.</p>","editPath":"core/mongodb.md","title":"MongoDB Support","previous":{"slug":"/docs/core/mercure/","title":"Pushing Live Updates Using the Mercure Protocol"},"next":{"slug":"/docs/core/elasticsearch/","title":"Elasticsearch Support"}}}